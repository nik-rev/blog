<!doctype html><html data-theme=dark lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta media="(prefers-color-scheme: light)" content=#418001 name=theme-color><meta media="(prefers-color-scheme: dark)" content=#cbefa6 name=theme-color><title>
        Combining path segments in Rust's declarative macros is harder than it seems
      </title><link href="https://nikrev.com/css/index.css?h=e00e2d1694315dd6673a" rel=stylesheet><script defer src=/js/theme_toggle.js></script><meta content="Nik Revenco" name=author><meta value="Combining path segments in Rust's declarative macros is harder than it seems" key=title property=og-image-generator><meta content="Combining path segments in Rust's declarative macros is harder than it seems" property=og:title><meta content="Nik Revenco's blog" property=og:description><meta content="Combining path segments in Rust's declarative macros is harder than it seems" itemprop=headline><meta content="Nik Revenco's blog" name=description><meta content=https://nikrev.com/blog/a-curious-way-to-combine-module-paths-in-rust-declarative-macros/ property=og:url><meta content=summary_large_image name=og:type><meta content=summary_large_image property=twitter:card><meta content="Combining path segments in Rust's declarative macros is harder than it seems" property=twitter:title><meta content=https://nikrev.com/blog/a-curious-way-to-combine-module-paths-in-rust-declarative-macros/og.png property=og:image><meta content="Combining path segments in Rust's declarative macros is harder than it seems" property=og:image:alt><meta content=1280 property=og:image:width><meta content=675 property=og:image:height><meta content=1280 property=twitter:image:width><meta content=675 property=twitter:image:height><body><div id=site><header class=header><div class=header__heading><a class=header__heading__title href=/> nik-rev </a><div class=header__heading__icon-container><button aria-label="Change to light theme" title="Change to light theme" class=header__heading__theme-toggle type=button>  <svg viewbox="0 0 512 512" class=header__heading__theme-toggle__icon fill=currentColor stroke=currentColor stroke-width=0 xmlns=http://www.w3.org/2000/svg><path d="M264 480A232 232 0 0 1 32 248c0-94 54-178.28 137.61-214.67a16 16 0 0 1 21.06 21.06C181.07 76.43 176 104.66 176 136c0 110.28 89.72 200 200 200 31.34 0 59.57-5.07 81.61-14.67a16 16 0 0 1 21.06 21.06C442.28 426 358 480 264 480z"></path></svg></button><button aria-label="RSS Feed" title="RSS Feed" class=header__heading__rss type=button><a href=https://nikrev.com/atom.xml> <svg viewbox="0 0 512 512" class=header__heading__rss__icon fill=currentColor stroke=currentColor stroke-width=0 xmlns=http://www.w3.org/2000/svg><path d="M119.9 336.1c-30.8 0-55.9 25.1-55.9 55.8 0 30.8 25.1 55.6 55.9 55.6 30.9 0 55.9-24.9 55.9-55.6 0-30.7-25-55.8-55.9-55.8z"></path><path d="M64 192v79.9c48 0 94.1 14.2 128 48.1 33.9 33.9 48 79.9 48 128h80c0-139.9-116-256-256-256z"></path><path d="M64 64v79.9c171 0 303.9 133 303.9 304.1H448C448 236.3 276 64 64 64z"></path></svg> </a></button></div></div></header><main class=post-content><h1 class=post-content__title>Combining path segments in Rust’s declarative macros is harder than it seems</h1><p class=post-content__date>16 May, 2025<p>Today, I ran into an interesting problem with a not-so-obvious solution: How do you concatenate path segments in Rust’s declarative macros?<h2 id=why-i-need-to-do-this><a aria-label="Anchor link for: why-i-need-to-do-this" class=zola-anchor href=#why-i-need-to-do-this>Why I need to do this</a></h2><p>In my project <a href=https://github.com/nik-rev/ferrishot>ferrishot</a> I have two <em>very</em> similar enums:<pre class="language-rs z-code" data-lang=rs><code class=language-rs data-lang=rs><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">Command</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    ImageUpload<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">image<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">action<span class="z-punctuation z-accessor z-rust">::</span></span>Command</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    App<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">app<span class="z-punctuation z-accessor z-rust">::</span></span>Command</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    DebugOverlay<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">debug_overlay<span class="z-punctuation z-accessor z-rust">::</span></span>Command</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    KeybindingsCheatsheet<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">keybindings_cheatsheet<span class="z-punctuation z-accessor z-rust">::</span></span>Command</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    Letters<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">popup<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">letters<span class="z-punctuation z-accessor z-rust">::</span></span>Command</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    Selection<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">selection<span class="z-punctuation z-accessor z-rust">::</span></span>Command</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">KeymappableCommand</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    ImageUpload<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">image<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">action<span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    App<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">app<span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    DebugOverlay<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">debug_overlay<span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    KeybindingsCheatsheet<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">keybindings_cheatsheet<span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    Letters<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">popup<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">letters<span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    Selection<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">selection<span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>Each <code>Command</code> and <code>KeymappableCommand</code> pair is created by a macro in their specific module.<hr><p><code>KeymappableCommand</code> is almost the same as <code>Command</code>, but it has additional fields representing the keystrokes required to invoke this command.<p>This enum is used to parse the <a href=https://kdl.dev/>KDL</a> config file using <a href=https://github.com/TheLostLambda/knus>knus</a>:<pre class="language-json z-code" data-lang=json><code class=language-json data-lang=json><span class="z-source z-json">keys <span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span>
</span></span><span class="z-source z-json"><span class="z-meta z-mapping z-json">  <span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">x</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">t</span> <span class="z-invalid z-illegal z-expected-mapping-key z-json">w</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">a</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">t</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">=</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">1</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">0</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span> <span class="z-invalid z-illegal z-expected-mapping-key z-json">k</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">y</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">=</span><span class="z-invalid z-illegal z-expected-mapping-key z-json"><</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">c</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">></span>
</span></span><span class="z-source z-json"><span class="z-meta z-mapping z-json">  <span class="z-invalid z-illegal z-expected-mapping-key z-json">c</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">p</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">y</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">-</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">t</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">-</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">c</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">l</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">p</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">b</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">a</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">r</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span> <span class="z-invalid z-illegal z-expected-mapping-key z-json">k</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">y</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">=</span><span class="z-invalid z-illegal z-expected-mapping-key z-json"><</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">n</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">t</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">r</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">></span>
</span></span><span class="z-source z-json"><span class="z-meta z-mapping z-json">  <span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">a</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">v</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">-</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">c</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">r</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">n</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">h</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">t</span> <span class="z-invalid z-illegal z-expected-mapping-key z-json">m</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">=</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">c</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">t</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">r</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">l</span> <span class="z-invalid z-illegal z-expected-mapping-key z-json">k</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">y</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">=</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span>
</span></span><span class="z-source z-json"><span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-end z-json">}</span></span>
</span></code></pre><p>By parsing that we will have something like this:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-keyword z-other z-rust">crate</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">image<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">action<span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-support z-macro z-rust">vec!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">  <span class="z-meta z-path z-rust">KeymappableCommand<span class="z-punctuation z-accessor z-rust">::</span></span>Exit <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">    wait<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">Duration<span class="z-punctuation z-accessor z-rust">::</span></span>from_seconds<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">10</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">    key<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">Key<span class="z-punctuation z-accessor z-rust">::</span></span>Escape<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">    mods<span class="z-punctuation z-separator z-rust">:</span> <span class="z-support z-type z-rust">None</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">  </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">  <span class="z-meta z-path z-rust">KeymappableCommand<span class="z-punctuation z-accessor z-rust">::</span></span>CopyToClipboard <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">    key<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">Key<span class="z-punctuation z-accessor z-rust">::</span></span>Enter<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">    mods<span class="z-punctuation z-separator z-rust">:</span> <span class="z-support z-type z-rust">None</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">  </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">  <span class="z-meta z-path z-rust">KeymappableCommand<span class="z-punctuation z-accessor z-rust">::</span></span>SaveScreenshot <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">    key<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">Key<span class="z-punctuation z-accessor z-rust">::</span></span>Character<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">'</span>s<span class="z-punctuation z-definition z-string z-end z-rust">'</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">    mods<span class="z-punctuation z-separator z-rust">:</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Modifier<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-constant z-other z-rust">CTRL</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">  </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span></code></pre><p>What we actually store is a <code>HashMap&LTKEYS, Command></code> where <code>Command</code> is a version of <code>KeymappableCommand</code> that excludes the <code>key</code> and <code>mods</code> field, where <code>KEYS</code> is a tuple of said <code>(key, mods)</code>.<p>This allows us to retrieve the correct <code>Command</code> for any given key sequence in <code>O(1)</code> time.<p>Each module has its own pair of <code>(KeymappableCommand, Command)</code>, and then there are 2 separate enums at the root of the crate: <code>crate::KeymappableCommand</code> and <code>crate::Command</code> which <em>compose</em> all of the other <code>KeymappableCommand</code>s and <code>Command</code>s from other module.<h2 id=the-naive-approach><a aria-label="Anchor link for: the-naive-approach" class=zola-anchor href=#the-naive-approach>The naive approach</a></h2><p>In order to create a macro that lets me define the following:<pre class="language-rs z-code" data-lang=rs><code class=language-rs data-lang=rs><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">Command</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    ImageUpload<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">image<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">action<span class="z-punctuation z-accessor z-rust">::</span></span>Command</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    App<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">app<span class="z-punctuation z-accessor z-rust">::</span></span>Command</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    Letters<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">popup<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">letters<span class="z-punctuation z-accessor z-rust">::</span></span>Command</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">KeymappableCommand</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    ImageUpload<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">image<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">action<span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    App<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">app<span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    Letters<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">popup<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">letters<span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>As follows, for instance:<pre class="language-rs z-code" data-lang=rs><code class=language-rs data-lang=rs><span class="z-source z-rust"><span class="z-support z-macro z-rust">declare_commands!</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    ImageUpload<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">image<span class="z-punctuation z-accessor z-rust">::</span></span>action</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    App<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span>app</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    Letters<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ui<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">popup<span class="z-punctuation z-accessor z-rust">::</span></span>letters</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre><p>I need to just write the path once, then concatenate it with the item I want to use. I initially tried this:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> surely, this will work right?
</span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-support z-function z-rust">macro_rules!</span> <span class="z-entity z-name z-macro z-rust">declare_commands</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span></span><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">  <span class="z-meta z-group z-macro-matcher z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-macro-matcher z-rust">    <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust"><span class="z-keyword z-operator z-rust">$</span>(</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-macro-matcher z-rust"><span class="z-meta z-group z-rust">      <span class="z-variable z-parameter z-macro z-rust">$Variant</span><span class="z-punctuation z-separator z-rust">:</span><span class="z-storage z-type z-rust">ident</span>(<span class="z-variable z-parameter z-macro z-rust">$path</span><span class="z-punctuation z-separator z-rust">:</span><span class="z-storage z-type z-rust">path</span><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-macro-matcher z-rust">    <span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-macro-matcher z-rust">,</span>*
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">  ) => {
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">    pub enum Command {
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">      $<span class="z-meta z-group z-macro-matcher z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-macro-matcher z-rust">        $Variant($path::Command<span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">      ),*
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">    </span></span><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust">    <span class="z-meta z-enum z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">KeymappableCommand</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">      <span class="z-keyword z-operator z-rust">$</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-variable z-other z-rust">$Variant</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-other z-rust">$path</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">      </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">  }
</span><span class="z-source z-rust">}
</span></code></pre><p>It feels like it should work. But specifically, this part is not valid Rust:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-variable z-other z-rust">$path</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>Command
</span><span class="z-source z-rust"><span class="z-variable z-other z-rust">$path</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand
</span></code></pre><p>But an attempt to compile the above results in an error:<div class=error><pre class=z-code><code><span class="z-text z-plain">error: missing angle brackets in associated item path
</span><span class="z-text z-plain">  --> src/main.rs:30:18
</span><span class="z-text z-plain">   |
</span><span class="z-text z-plain">30 |           $Variant($path::Command)
</span><span class="z-text z-plain">   |                    ^^^^^
</span><span class="z-text z-plain">...
</span><span class="z-text z-plain">42 | / declare_commands! {
</span><span class="z-text z-plain">43 | |    ImageUpload(crate::image::action),
</span><span class="z-text z-plain">44 | |    App(ui::app),
</span><span class="z-text z-plain">45 | |    Letters(ui::popup::letters)
</span><span class="z-text z-plain">46 | | }
</span><span class="z-text z-plain">   | |_- in this macro invocation
</span><span class="z-text z-plain">   |
</span><span class="z-text z-plain">   = note: this error originates in the macro `declare_commands` (in Nightly builds, run with -Z macro-backtrace for more info)
</span><span class="z-text z-plain">help: types that don't start with an identifier need to be surrounded with angle brackets in qualified paths
</span><span class="z-text z-plain">   |
</span><span class="z-text z-plain">30 |         $Variant(<$path>::Command)
</span><span class="z-text z-plain">   |                  +     +
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">error: missing angle brackets in associated item path
</span><span class="z-text z-plain">  --> src/main.rs:36:18
</span><span class="z-text z-plain">   |
</span><span class="z-text z-plain">36 |           $Variant($path::KeymappableCommand)
</span><span class="z-text z-plain">   |                    ^^^^^
</span><span class="z-text z-plain">...
</span><span class="z-text z-plain">42 | / declare_commands! {
</span><span class="z-text z-plain">43 | |    ImageUpload(crate::image::action),
</span><span class="z-text z-plain">44 | |    App(ui::app),
</span><span class="z-text z-plain">45 | |    Letters(ui::popup::letters)
</span><span class="z-text z-plain">46 | | }
</span><span class="z-text z-plain">   | |_- in this macro invocation
</span></code></pre></div><p>The suggestion to add <code>< ></code> is incorrect here, as that is not valid syntax for referencing items in modules.<p>If we try the advice, we get another error:<div class=error><pre class=z-code><code><span class="z-text z-plain">error[E0573]: expected type, found module `crate::image::action`
</span><span class="z-text z-plain">  --> src/main.rs:43:16
</span><span class="z-text z-plain">   |
</span><span class="z-text z-plain">43 |    ImageUpload(crate::image::action),
</span><span class="z-text z-plain">   |                ^^^^^^^^^^^^^^^^^^^^ not a type
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">error[E0573]: expected type, found module `ui::app`
</span><span class="z-text z-plain">  --> src/main.rs:44:8
</span><span class="z-text z-plain">   |
</span><span class="z-text z-plain">44 |    App(ui::app),
</span><span class="z-text z-plain">   |        ^^^^^^^ not a type
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">error[E0412]: cannot find type `letters` in module `ui::popup`
</span><span class="z-text z-plain">  --> src/main.rs:45:23
</span><span class="z-text z-plain">   |
</span><span class="z-text z-plain">45 |    Letters(ui::popup::letters)
</span><span class="z-text z-plain">   |                       ^^^^^^^ not found in `ui::popup`
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">Some errors have detailed explanations: E0412, E0573.
</span><span class="z-text z-plain">For more information about an error, try `rustc --explain E0412`.
</span><span class="z-text z-plain">error: could not compile `macro_example` (bin "macro_example") due to 3 previous errors
</span></code></pre></div><p>Composing path segments like this does not have an obvious solution. I initially tried the <a href=https://crates.io/crates/paste>paste</a> crate which lets you compose identifiers in this manner:<h3 id=tried-paste><a aria-label="Anchor link for: tried-paste" class=zola-anchor href=#tried-paste>Tried <code>paste!</code></a></h3><pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-support z-function z-rust">macro_rules!</span> <span class="z-entity z-name z-macro z-rust">declare_commands</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span></span><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">  <span class="z-meta z-group z-macro-matcher z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-macro-matcher z-rust">    <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust"><span class="z-keyword z-operator z-rust">$</span>(</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-macro-matcher z-rust"><span class="z-meta z-group z-rust">      <span class="z-variable z-parameter z-macro z-rust">$Variant</span><span class="z-punctuation z-separator z-rust">:</span><span class="z-storage z-type z-rust">ident</span>(<span class="z-variable z-parameter z-macro z-rust">$path</span><span class="z-punctuation z-separator z-rust">:</span><span class="z-storage z-type z-rust">path</span><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-macro-matcher z-rust">    <span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-macro-matcher z-rust">,</span>*
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">  ) => {
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">    pub enum Command {
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">      $<span class="z-meta z-group z-macro-matcher z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-macro-matcher z-rust">        $Variant(paste! {[<$path::Command>]}<span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">      ),*
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">    </span></span><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust">    <span class="z-meta z-enum z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">KeymappableCommand</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">      <span class="z-keyword z-operator z-rust">$</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-variable z-other z-rust">$Variant</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-macro z-rust">paste!</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-keyword z-operator z-comparison z-rust"><</span><span class="z-variable z-other z-rust">$path</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand<span class="z-keyword z-operator z-comparison z-rust">></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">      </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">  }
</span><span class="z-source z-rust">}
</span></code></pre><p>But <code>paste!</code> does not work for composing paths like that.<div class=error><pre class=z-code><code><span class="z-text z-plain">error: expected identifier after `:`
</span><span class="z-text z-plain">  --> src/main.rs:44:22
</span><span class="z-text z-plain">   |
</span><span class="z-text z-plain">44 |    ImageUpload(crate::image::action),
</span><span class="z-text z-plain">   |                      ^
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">error: expected identifier after `:`
</span><span class="z-text z-plain">  --> src/main.rs:45:11
</span><span class="z-text z-plain">   |
</span><span class="z-text z-plain">45 |    App(ui::app),
</span><span class="z-text z-plain">   |           ^
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">error: expected identifier after `:`
</span><span class="z-text z-plain">  --> src/main.rs:46:15
</span><span class="z-text z-plain">   |
</span><span class="z-text z-plain">46 |    Letters(ui::popup::letters)
</span><span class="z-text z-plain">   |               ^
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">error: could not compile `macro_example` (bin "macro_example") due to 6 previous errors
</span></code></pre></div><h2 id=the-solution><a aria-label="Anchor link for: the-solution" class=zola-anchor href=#the-solution>The Solution</a></h2><p>If we look at what a path is, it’s just identifiers (<code>ident</code>) separated by double-colon <code>::</code>:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-path z-rust">path<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">to<span class="z-punctuation z-accessor z-rust">::</span></span>some_module
</span></code></pre><p>You can represent the above using the following macro specifier:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-operator z-rust">$</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">  <span class="z-variable z-other z-rust">$segment</span><span class="z-punctuation z-separator z-rust">:</span>ident
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">:</span><span class="z-punctuation z-separator z-rust">:</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>
</span></code></pre><ul><li><code>$( ... )*</code> denotes a repetition<li><code>$( ... )SEPARATOR*</code> denotes a repetition, but we have to insert the <code>SEPARATOR</code> in-between each repetition.</ul><p>In <code>path::to::some_module</code>, it would parse as follows:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-variable z-other z-rust">$segment</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `path`
</span></span><span class="z-source z-rust"><span class="z-punctuation z-separator z-rust">:</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `SEPARATOR`
</span></span><span class="z-source z-rust"><span class="z-variable z-other z-rust">$segment</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `to`
</span></span><span class="z-source z-rust"><span class="z-punctuation z-separator z-rust">:</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `SEPARATOR`
</span></span><span class="z-source z-rust"><span class="z-variable z-other z-rust">$segment</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `some_module`
</span></span></code></pre><p>Then, using <code>$($segment)::*</code> in a similar fashion <em>expands</em> this repetition to the path:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust">path <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `<span class="z-variable z-other z-rust">$segment</span>`
</span></span><span class="z-source z-rust"><span class="z-punctuation z-separator z-rust">:</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `SEPARATOR`
</span></span><span class="z-source z-rust">to <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `<span class="z-variable z-other z-rust">$segment</span>`
</span></span><span class="z-source z-rust"><span class="z-punctuation z-separator z-rust">:</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `SEPARATOR`
</span></span><span class="z-source z-rust">some_module <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `<span class="z-variable z-other z-rust">$segment</span>`
</span></span></code></pre><p>And what’s interesting is that we can compose <em>this</em> with another double-colon <code>::</code> followed by an identifier (<code>ident</code>) like this:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-operator z-rust">$</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-other z-rust">$segment</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">:</span><span class="z-punctuation z-separator z-rust">:</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>some_identifier
</span></code></pre><p>The above (with <code>path::to::some_module</code> as <code>$($segment)::*</code>) will expand to this:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-path z-rust">path<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">to<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">some_module<span class="z-punctuation z-accessor z-rust">::</span></span>some_identifier
</span></code></pre><p>I have looked for a long time and haven’t found anyone talk about this. So the correct version of the macro I tried to make is this:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-support z-function z-rust">macro_rules!</span> <span class="z-entity z-name z-macro z-rust">declare_commands</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span></span><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">  <span class="z-meta z-group z-macro-matcher z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-macro-matcher z-rust">    <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust"><span class="z-keyword z-operator z-rust">$</span>(</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-macro-matcher z-rust"><span class="z-meta z-group z-rust">      <span class="z-variable z-parameter z-macro z-rust">$Variant</span><span class="z-punctuation z-separator z-rust">:</span><span class="z-storage z-type z-rust">ident</span>($(<span class="z-variable z-parameter z-macro z-rust">$segment</span><span class="z-punctuation z-separator z-rust">:</span><span class="z-storage z-type z-rust">ident</span><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>::*<span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">    ),*
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">  ) => {
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">    pub enum Command {
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">      $<span class="z-meta z-group z-macro-matcher z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-macro-matcher z-rust">        $Variant(<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust"><span class="z-keyword z-operator z-rust">$</span>(</span>$segment<span class="z-punctuation z-section z-group z-end z-rust">)</span></span>::*::Command<span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">      ),*
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">    </span></span><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust">    <span class="z-meta z-enum z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">KeymappableCommand</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">      <span class="z-keyword z-operator z-rust">$</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-variable z-other z-rust">$Variant</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">$</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-other z-rust">$segment</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">:</span><span class="z-punctuation z-separator z-rust">:</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>KeymappableCommand</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">      </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">  }
</span><span class="z-source z-rust">}
</span></code></pre><p><a href=https://nikrev.com/blog/a-curious-way-to-combine-module-paths-in-rust-declarative-macros/main.rs>See the full code</a></main></div>