<!doctype html><html data-theme=dark lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta media="(prefers-color-scheme: light)" content=#418001 name=theme-color><meta media="(prefers-color-scheme: dark)" content=#cbefa6 name=theme-color><title>
        Rust's built-in macros such as `include_str!` can eagerly expand inner macros. Can we do the same?
      </title><link href="https://nikrev.com/css/index.css?h=e00e2d1694315dd6673a" rel=stylesheet><script defer src=/js/theme_toggle.js></script><meta content="Nik Revenco" name=author><meta value="Rust's built-in macros such as `include_str!` can eagerly expand inner macros. Can we do the same?" key=title property=og-image-generator><meta content="Rust's built-in macros such as `include_str!` can eagerly expand inner macros. Can we do the same?" property=og:title><meta content="Nik Revenco's blog" property=og:description><meta content="Rust's built-in macros such as `include_str!` can eagerly expand inner macros. Can we do the same?" itemprop=headline><meta content="Nik Revenco's blog" name=description><meta content=https://nikrev.com/blog/lit-str-concat-macro/ property=og:url><meta content=summary_large_image name=og:type><meta content=summary_large_image property=twitter:card><meta content="Rust's built-in macros such as `include_str!` can eagerly expand inner macros. Can we do the same?" property=twitter:title><meta content=https://nikrev.com/blog/lit-str-concat-macro/og.png property=og:image><meta content="Rust's built-in macros such as `include_str!` can eagerly expand inner macros. Can we do the same?" property=og:image:alt><meta content=1280 property=og:image:width><meta content=675 property=og:image:height><meta content=1280 property=twitter:image:width><meta content=675 property=twitter:image:height><body><div id=site><header class=header><div class=header__heading><a class=header__heading__title href=/> nik-rev </a><div class=header__heading__icon-container><button aria-label="Change to light theme" title="Change to light theme" class=header__heading__theme-toggle type=button>  <svg viewbox="0 0 512 512" class=header__heading__theme-toggle__icon fill=currentColor stroke=currentColor stroke-width=0 xmlns=http://www.w3.org/2000/svg><path d="M264 480A232 232 0 0 1 32 248c0-94 54-178.28 137.61-214.67a16 16 0 0 1 21.06 21.06C181.07 76.43 176 104.66 176 136c0 110.28 89.72 200 200 200 31.34 0 59.57-5.07 81.61-14.67a16 16 0 0 1 21.06 21.06C442.28 426 358 480 264 480z"></path></svg></button><button aria-label="RSS Feed" title="RSS Feed" class=header__heading__rss type=button><a href=https://nikrev.com/atom.xml> <svg viewbox="0 0 512 512" class=header__heading__rss__icon fill=currentColor stroke=currentColor stroke-width=0 xmlns=http://www.w3.org/2000/svg><path d="M119.9 336.1c-30.8 0-55.9 25.1-55.9 55.8 0 30.8 25.1 55.6 55.9 55.6 30.9 0 55.9-24.9 55.9-55.6 0-30.7-25-55.8-55.9-55.8z"></path><path d="M64 192v79.9c48 0 94.1 14.2 128 48.1 33.9 33.9 48 79.9 48 128h80c0-139.9-116-256-256-256z"></path><path d="M64 64v79.9c171 0 303.9 133 303.9 304.1H448C448 236.3 276 64 64 64z"></path></svg> </a></button></div></div></header><main class=post-content><h1 class=post-content__title>Rust’s built-in macros such as <code>include_str!</code> can eagerly expand inner macros. Can we do the same?</h1><p class=post-content__date>27 February, 2025<p>You can use the <code>concat!</code> macro to pass string literals into macros:<pre class="language-rs z-code" data-lang=rs><code class=language-rs data-lang=rs><span class="z-source z-rust"><span class="z-support z-macro z-rust">env!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>ab<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span><span class="z-source z-rust"><span class="z-support z-macro z-rust">env!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-macro z-rust">concat!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>a<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>b<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></code></pre><p>Both of the above calls will <strong>become</strong> <code>env!("ab")</code>.<p>However, a macro created using the <a href=https://crates.io/crates/syn><code>syn</code></a> crate that expects a literal string <code>syn::LitStr</code> as its input, such as Dioxus’s <a href=https://docs.rs/dioxus/0.6.3/dioxus/prelude/macro.asset.html><code>asset!</code></a> macro:<pre class="language-rs z-code" data-lang=rs><code class=language-rs data-lang=rs><span class="z-source z-rust"><span class="z-support z-macro z-rust">asset!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>/assets/icons/github.svg<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></code></pre><p>Will <em>not</em> be able to receive <code>concat!</code>.<p>This does not compile.<pre class="language-rs z-code" data-lang=rs><code class=language-rs data-lang=rs><span class="z-source z-rust"><span class="z-support z-macro z-rust">asset!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-macro z-rust">concat!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>/assets/icons/<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>github<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>.svg<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></code></pre><div class=error><pre class=z-code><code><span class="z-text z-plain">ERROR: Expected a string literal
</span></code></pre></div><p>I assume this is because the <code>asset!</code> macro expects a string literal. But <em>is</em> <code>concat!("...", "...")</code> a string literal?<p>Because <code>concat!(...)</code> itself only accepts string literals, and you can use it inside of itself: <code>concat!(concat!(""))</code>, it <strong>must</strong> be, right? For this to work, the macro has to be evaluated in this order.<ol><li>Macro expands<li>The expanded form is passed inside the <code>concat!</code></ol><p>When you try to write your own macro that can do the above, you’ll notice it isn’t possible.<p>Rust’s macros such as <code>include_str!</code> and <code>env!</code> have a special “superpower” where they can expand the <code>concat!</code> macro <em>before</em> parsing. However, user-created declarative macros using the <code>syn</code> crate are unable to.<p>These macros get the raw <code>TokenStream</code> corresponding to the tokens in <code>"concat!("/assets/icons/", "github", ".svg"))"</code><h2 id=solution><a aria-label="Anchor link for: solution" class=zola-anchor href=#solution>Solution</a></h2><p>Thankfully, the amazing <a href=https://github.com/dtolnay>David Tolnay</a> shared a pretty cool crate called <a href=https://crates.io/crates/macro-string><code>macro-string</code></a> which allows creating a derive macro which eagerly evaluates the following <code>std</code> macros, at the time of writing:<ul><li><code>concat!</code><li><code>env!</code><li><code>include!</code><li><code>include_str!</code><li><code>stringify!</code></ul><p>Meaning you’ll be able to pass them into macros that expect a string literal, and they’ll get expanded <em>before</em> being passed to the macro!</main></div>